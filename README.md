# An LLVM Front End for BCPL

## The Objective

This is work-in-progress to develop the above as a standard BCPL code generator.
That is, its API allows it to be used with the *SYN* and *TRN* phases distributed
as part of the standard distribution of the BCPL kit from Martin Richards.

This means:

- the source code is included in the same source file as SYN and TRN,
- the entry point is the function *codegenerate*, which expects the usual two arguments, the location of some workspace and its size,
- *codegenerate* used the function *rdn* defined by *SYN* to read the OCODE generated by *TRN*
- *codegenerate* translates the OCODE into optimised LLVM IR and writes the result to the stream *gostream*, opened by *SYN*.

The current target language and runtime is that specified by

    A PROPOSED DEFINITION OF THE LANGUAGE BCPL,
    M.D. Middleton, R. Firth, M. Richards, I. Willers,
    1st October 1979

up to but not including the appendix (which defines extensions). Once that
target has been reached, the appendix will be included (providing floating
point and the heap, among other things).

## Stages of Development

### 1. Interpreted Compiler

A BCPL compiler interpreted under CINTSTS64 using the LLVM toolchain that
compiles, via LLVM-IR, to native code which runs using a run-time layered
on top of the host's C RTL

### 2. Native Compiler

A native BCPL compiler running on the host using the LLVM toolchain and
a run-time layered on top of the hosts C RTL that compiles, via LLVM-IR,
to native code which also runs using the same run-time layered on top of
the host's C RTL.

The native compiler can compile itself.

### 3. Native Compiler and Runtime

A native BCPL compiler running on the host using using the LLVM toolchain
and BCPL run-time using system calls and compiles, via LLVM IR, to native
code which also runs using the same BCPL run-time.

## The Current State of Play

Stages 2 have just been reached. It passes a number of regression tests
and correctly compiles itself. It now needs some proper testing.

- It uses LLVM 20.1.6
- The OCODE operations supporting SLCT are now implemented
- The BCPL standard requires arguments to routines to have adjacent addresses so that it is possible to take the address of the first argument and treat the argument as a vector. The code generator does not honour this.
- Much of CMPLTEST currently passes, skipping the floating point tests
- According to section 2.4.5 of the BCPL Cintsys and Cintpos User Guide, local variables are allocated consecutive locations in the stack frame of the current function. The "Proposed Definition" does not mention this and the code generator does not honour it at the moment.

